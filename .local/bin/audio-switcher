#!/bin/bash
# Audio device switcher â€” fzf in foot for consistency with other pickers

bold=$'\e[1m'
dim=$'\e[2m'
reset=$'\e[0m'
green=$'\e[32m'
cyan=$'\e[36m'
yellow=$'\e[33m'

get_sinks() {
    local default_sink
    default_sink=$(pactl get-default-sink 2>/dev/null)
    pactl list sinks short | while read -r id name _rest; do
        desc=$(pactl list sinks | grep -A1 "Name: $name" | grep "Description:" | sed 's/.*Description: //')
        vol=$(pactl get-sink-volume "$name" 2>/dev/null | grep -oP '\d+%' | head -1)
        muted=$(pactl get-sink-mute "$name" 2>/dev/null | grep -oP 'yes|no')
        marker="  "
        [[ "$name" == "$default_sink" ]] && marker="${green}*${reset} "
        [[ "$muted" == "yes" ]] && vol="${dim}${vol} [muted]${reset}"
        printf "%s${bold}%s${reset} ${dim}%s${reset}\n" "$marker" "$desc" "$vol"
    done
}

get_sources() {
    local default_source
    default_source=$(pactl get-default-source 2>/dev/null)
    pactl list sources short | grep -v '\.monitor' | while read -r id name _rest; do
        desc=$(pactl list sources | grep -A1 "Name: $name" | grep "Description:" | sed 's/.*Description: //')
        vol=$(pactl get-source-volume "$name" 2>/dev/null | grep -oP '\d+%' | head -1)
        marker="  "
        [[ "$name" == "$default_source" ]] && marker="${green}*${reset} "
        printf "%s${bold}%s${reset} ${dim}%s${reset}\n" "$marker" "$desc" "$vol"
    done
}

resolve_name() {
    local desc="$1" type="$2"
    local list_cmd="sinks"
    [[ "$type" == "source" ]] && list_cmd="sources"
    pactl list "$list_cmd" | grep -B1 "Description: $desc" | grep "Name:" | sed 's/.*Name: //'
}

# Pick category
mode=$(printf "${cyan}  Output${reset}\n${yellow}  Input${reset}" | fzf \
    --ansi --height=100% --layout=reverse \
    --header="${bold}Audio Switcher${reset}" \
    --no-info --pointer=">" --no-scrollbar)

[[ -z "$mode" ]] && exit 0

if [[ "$mode" == *"Output"* ]]; then
    selection=$(get_sinks | fzf \
        --ansi --height=100% --layout=reverse \
        --header="${bold}Select output${reset}" \
        --no-info --pointer=">" --no-scrollbar)

    [[ -z "$selection" ]] && exit 0

    # Strip the marker and volume to get description
    desc=$(echo "$selection" | sed -E 's/^.{2}//' | sed -E 's/^(\x1b\[[0-9;]*m)*\*(\x1b\[[0-9;]*m)* //' | sed -E 's/ +\x1b\[2m.*$//')
    # Clean ANSI from desc
    desc=$(echo "$desc" | sed 's/\x1b\[[0-9;]*m//g' | xargs)
    sink=$(resolve_name "$desc" "sink")

    if [[ -n "$sink" ]]; then
        pactl set-default-sink "$sink"
        pactl list sink-inputs short | awk '{print $1}' | while read -r input; do
            pactl move-sink-input "$input" "$sink"
        done
        log_message "  $desc" && sleep 3 && log_message ""
    fi

elif [[ "$mode" == *"Input"* ]]; then
    selection=$(get_sources | fzf \
        --ansi --height=100% --layout=reverse \
        --header="${bold}Select input${reset}" \
        --no-info --pointer=">" --no-scrollbar)

    [[ -z "$selection" ]] && exit 0

    desc=$(echo "$selection" | sed -E 's/^.{2}//' | sed -E 's/^(\x1b\[[0-9;]*m)*\*(\x1b\[[0-9;]*m)* //' | sed -E 's/ +\x1b\[2m.*$//')
    desc=$(echo "$desc" | sed 's/\x1b\[[0-9;]*m//g' | xargs)
    source=$(resolve_name "$desc" "source")

    if [[ -n "$source" ]]; then
        pactl set-default-source "$source"
        pactl list source-outputs short | awk '{print $1}' | while read -r output; do
            pactl move-source-output "$output" "$source"
        done
        # Restart voice typing daemon so it picks up the new source
        pkill -f "enhanced-voice-typing.py" 2>/dev/null
        nohup voice-typing-daemon > /tmp/voice-typing.log 2>&1 &
        log_message "  $desc" && sleep 3 && log_message ""
    fi
fi

#!/bin/bash
# Audio device switcher â€” fzf in foot for consistency with other pickers

bold=$'\e[1m'
dim=$'\e[2m'
reset=$'\e[0m'
green=$'\e[32m'
cyan=$'\e[36m'
yellow=$'\e[33m'

get_sinks() {
    local default_sink
    default_sink=$(pactl get-default-sink 2>/dev/null)
    pactl list sinks short | while read -r id name _rest; do
        desc=$(pactl list sinks | grep -A1 "Name: $name" | grep "Description:" | sed 's/.*Description: //')
        vol=$(pactl get-sink-volume "$name" 2>/dev/null | grep -oP '\d+%' | head -1)
        muted=$(pactl get-sink-mute "$name" 2>/dev/null | grep -oP 'yes|no')
        marker="  "
        [[ "$name" == "$default_sink" ]] && marker="${green}*${reset} "
        mute_label=""
        [[ "$muted" == "yes" ]] && mute_label=" [muted]"
        printf "%s${bold}%s${reset} ${dim}%s%s${reset}\t%s\n" "$marker" "$desc" "$vol" "$mute_label" "$name"
    done
}

get_sources() {
    local default_source
    default_source=$(pactl get-default-source 2>/dev/null)
    pactl list sources short | grep -v '\.monitor' | while read -r id name _rest; do
        desc=$(pactl list sources | grep -A1 "Name: $name" | grep "Description:" | sed 's/.*Description: //')
        vol=$(pactl get-source-volume "$name" 2>/dev/null | grep -oP '\d+%' | head -1)
        marker="  "
        [[ "$name" == "$default_source" ]] && marker="${green}*${reset} "
        printf "%s${bold}%s${reset} ${dim}%s${reset}\t%s\n" "$marker" "$desc" "$vol" "$name"
    done
}

# Pick category
mode=$(printf "${cyan}  Output${reset}\n${yellow}  Input${reset}" | fzf \
    --ansi --height=100% --layout=reverse \
    --header="${bold}Audio Switcher${reset}" \
    --no-info --pointer=">" --no-scrollbar \
    --bind 'left-click:accept')

[[ -z "$mode" ]] && exit 0

if [[ "$mode" == *"Output"* ]]; then
    selection=$(get_sinks | fzf \
        --ansi --height=100% --layout=reverse \
        --header="${bold}Select output${reset}" \
        --no-info --pointer=">" --no-scrollbar \
        --delimiter='\t' --with-nth=1 \
        --bind 'left-click:accept')

    [[ -z "$selection" ]] && exit 0

    sink=$(printf '%s' "$selection" | awk -F'\t' '{print $NF}')

    if [[ -n "$sink" ]]; then
        pactl set-default-sink "$sink"
        pactl list sink-inputs short | awk '{print $1}' | while read -r input; do
            pactl move-sink-input "$input" "$sink"
        done
        desc=$(pactl list sinks | grep -A1 "Name: $sink" | grep "Description:" | sed 's/.*Description: //')
        log_message "  $desc" && sleep 3 && log_message ""
    fi

elif [[ "$mode" == *"Input"* ]]; then
    selection=$(get_sources | fzf \
        --ansi --height=100% --layout=reverse \
        --header="${bold}Select input${reset}" \
        --no-info --pointer=">" --no-scrollbar \
        --delimiter='\t' --with-nth=1 \
        --bind 'left-click:accept')

    [[ -z "$selection" ]] && exit 0

    source=$(printf '%s' "$selection" | awk -F'\t' '{print $NF}')

    if [[ -n "$source" ]]; then
        pactl set-default-source "$source"
        pactl list source-outputs short | awk '{print $1}' | while read -r output; do
            pactl move-source-output "$output" "$source"
        done
        # Restart voice typing daemon so it picks up the new source
        systemctl --user restart voice-typing 2>/dev/null &
        desc=$(pactl list sources | grep -A1 "Name: $source" | grep "Description:" | sed 's/.*Description: //')
        log_message "  $desc" && sleep 3 && log_message ""
    fi
fi

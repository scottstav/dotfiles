#!/bin/bash

log_message() {
  echo "$1" > /tmp/waybar-custom-output
}

export BW_CLIENTID="user.7689cf00-5cf4-495c-9987-b394002c0fae"
export BW_CLIENTSECRET="8PpGlC7ZOzBKhWgV8xIt2IWC4oqjG9"
bw logout
log_message "Logging into Bitwarden..."
bw login --apikey
log_message "Unlocking Bitwarden vault..."
echo $?


export BW_PASSWORD="MIDGETS-await-hpd-longer"
output=$(bw unlock --passwordenv BW_PASSWORD)
export BW_SESSION=$(echo "$output" | grep -oP 'export\s+\w+="[^"]*"' | cut -d'"' -f2)
log_message "Session initialized."
log_message "$BW_SESSION"
sleep 1
log_message ""

# check if emacs daemon is running
if pgrep -x "emacs" > /dev/null; then
    log_message "Emacs daemon is running."
    sleep 1
    log_message ""
    # run a setenv command in the emacs client to set to the BW_SESSION
    emacsclient -e "(setenv \"BW_SESSION\" \"$BW_SESSION\")" &
    log_message "Done"
    log_message ""
    exit 0
fi


echo "Starting emacs daemon..." > /tmp/waybar-custom-output
output=$(/usr/bin/emacs --daemon 2>&1)
exit_code=$?

if [ $exit_code -eq 0 ]; then
  echo "Emacs daemon initialized successfully!" > /tmp/waybar-custom-output
  sleep 2
  echo "" > /tmp/waybar-custom-output
else
  # Extract first 50 characters of the error message
  error_message=$(echo "$output" | head -c 50)
  echo "$error_message..." > /tmp/waybar-custom-output
  sleep 2
  echo "" > /tmp/waybar-custom-output
fi

echo "$Eww..." > /tmp/waybar-custom-output
eww daemon
echo "Done" > /tmp/waybar-custom-output
sleep 2
echo "" > /tmp/waybar-custom-output

#!/usr/bin/env bash
# Voice typing launcher with RealtimeSTT

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"

# Default to small model for better accuracy
DEFAULT_ARGS=""
if [ $# -eq 0 ]; then
    DEFAULT_ARGS="--model small"
    echo "Using 'small' model for better accuracy"
    echo "Options: tiny (fastest), base, small, medium, large-v2, large-v3 (most accurate)"
fi

# Check if we need to download the model first
MODEL_DIR="$HOME/.cache/whisper"
if [ ! -d "$MODEL_DIR" ]; then
    echo "First run: Whisper will download the model"
    echo "Small model = ~244MB (recommended for accuracy)"
    echo "This only happens once."
fi

# Check session type for informational purposes
if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
    echo "Running on Wayland - will use ydotool (requires ydotoold)"
    # Check if the ydotool service is running
    if ! systemctl is-active --quiet ydotoold; then
        echo "Note: ydotoold service is not running; keyboard input will not work"
    fi
elif [ "$XDG_SESSION_TYPE" = "x11" ]; then
    echo "Running on X11 - will use xdotool"
fi

# Run enhanced version (with pre-buffer to capture initial words)
exec nix-shell "$SCRIPT_DIR/shell.nix" --run "python \"$SCRIPT_DIR/enhanced-voice-typing.py\" $DEFAULT_ARGS $*"

#!/data/data/com.termux/files/usr/bin/bash
# Bidirectional Dropbox sync for all denote files

DENOTE_DIR="$HOME/storage/shared/Dropbox/org/denote"
REMOTE="Dropbox:org/denote"

mkdir -p "$DENOTE_DIR"

# --conflict-resolve newer: both sides changed â†’ keep newer, rename older with .conflict suffix
# --resilient: tolerate transient errors, allow retries without requiring --resync
# --recover: automatically recover from interrupted runs without --resync
if ! rclone bisync "$DENOTE_DIR" "$REMOTE" \
     --conflict-resolve newer \
     --resilient \
     --recover; then
  # Only --resync if no state file exists (first run on this device)
  if ! ls ~/.cache/rclone/bisync/*denote* >/dev/null 2>&1; then
    rclone bisync "$DENOTE_DIR" "$REMOTE" --resync --conflict-resolve newer
  else
    termux-notification -t "Denote sync failed" -c "Check termux for errors"
  fi
fi
termux-notification -t "Denote synced" -c "$(date +%H:%M)"
